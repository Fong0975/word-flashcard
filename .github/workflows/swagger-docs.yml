name: Generate and Deploy Swagger Documentation

on:
  push:
    branches: [ main ]
    paths:
      - 'internal/**'
      - 'main.go'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  generate-swagger:
    runs-on: ubuntu-latest

    steps:
    # Set pending status for manual triggers only
    - name: Set Pending Status
      if: github.event_name == 'workflow_dispatch'
      run: |
        curl -X POST \
        -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
        -d '{
          "state": "pending",
          "target_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
          "description": "Swagger docs generation in progress...",
          "context": "Swagger Docs (Manual)"
        }'

    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.23.7'

    - name: Clean Go module cache conflicts
      run: |
        go clean -modcache || true
        rm -rf ~/.cache/go-build || true

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/go-build
          ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Install dependencies
      run: go mod download

    - name: Install Swag CLI
      run: go install github.com/swaggo/swag/cmd/swag@latest

    - name: Generate Swagger documentation
      run: swag init

    - name: Create GitHub Pages content
      run: |
        mkdir -p public
        cp -r docs/* public/

        # Create index.html for GitHub Pages
        cat > public/index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Word Flashcard API Documentation</title>
            <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui.css" />
            <style>
                html {
                    box-sizing: border-box;
                    overflow: -moz-scrollbars-vertical;
                    overflow-y: scroll;
                }
                *, *:before, *:after {
                    box-sizing: inherit;
                }
                body {
                    margin:0;
                    background: #fafafa;
                }
            </style>
        </head>
        <body>
            <div id="swagger-ui"></div>
            <script src="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui-bundle.js"></script>
            <script src="https://unpkg.com/swagger-ui-dist@3.52.5/swagger-ui-standalone-preset.js"></script>
            <script>
                window.onload = function() {
                    const ui = SwaggerUIBundle({
                        url: './swagger.json',
                        dom_id: '#swagger-ui',
                        deepLinking: true,
                        presets: [
                            SwaggerUIBundle.presets.apis,
                            SwaggerUIStandalonePreset
                        ],
                        plugins: [
                            SwaggerUIBundle.plugins.DownloadUrl
                        ],
                        layout: "StandaloneLayout"
                    });
                };
            </script>
        </body>
        </html>
        EOF

    - name: Setup Pages
      uses: actions/configure-pages@v4

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: './public'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4

    # Update final status for manual triggers only
    - name: Update Final Status
      if: always() && github.event_name == 'workflow_dispatch'
      run: |
        # Determine state based on job status
        STATE="${{ job.status == 'success' && 'success' || 'failure' }}"

        curl -X POST \
        -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
        -H "Accept: application/vnd.github.v3+json" \
        https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
        -d "{
          \"state\": \"$STATE\",
          \"target_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\",
          \"description\": \"Swagger docs generation completed\",
          \"context\": \"Swagger Docs (Manual)\"
        }"